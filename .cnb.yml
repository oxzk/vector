main:
  "crontab: 0 * * * *":
    - name: Run
      runner:
        cpus: 2
      docker:
        image: docker.cnb.cool/oxzk.co/code-server:latest
      imports: https://cnb.cool/oxzk.co/env/-/blob/main/vector.json
      stages:
        - name: Set up Python venv
          script: |
            cd /workspace
            echo $SHELL
            ls -la ~
            if [ ! -d ".venv" ]; then
              python3 -m venv .venv
            fi
            
            if command -v pip >/dev/null 2>&1; then
                echo "pip 已安装"
            else
                echo "pip 未安装"
                . .venv/bin/activate

            python --version
            cat /root/.cnb/v2ray-config.json

        - name: Install dependencies
          script: |
            pip install -r requirements.txt

        # - name: Run
        #   script: |
        #     python cli.py db_test

        - name: Cleanup
          script: |
            echo "Validation task completed"
            rm -rf /workspace/.venv
          condition: always()

# main:
#   push:
#     - runner:
#         cpus: 2
#       docker:
#         image: docker.cnb.cool/oxzk.co/code-server:latest
#       imports: https://cnb.cool/oxzk.co/env/-/blob/main/v2ray.json
#       stages:
#         - name: python
#           script: |
#             ls -la
#             nohup v2ray -c /root/.cnb/v2ray-config.json >/dev/null 2>&1 &

$:
  vscode:
    - runner:
        cpus: 4
        # tags: cnb:arch:amd64:gpu
      docker:
        image: docker.cnb.cool/oxzk.co/code-server:latest
      services:
        - vscode
        - docker
      stages:
        - name: cnb-init
          script: |
            bash /root/.cnb/cnb-init.sh
      endStages:
        - name: cnb-end
          script: |
            bash /root/.cnb/cnb-destory.sh